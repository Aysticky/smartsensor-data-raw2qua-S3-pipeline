name: CD - Deploy to Dev

on:
  push:
    branches: [develop]  # Auto-deploy dev when code is pushed to develop
  workflow_dispatch:  # Also allow manual trigger

# DEV DEPLOYMENT STRATEGY:
# - Auto-deploy on push to develop branch
# - Use sanders-platform-dev IAM user credentials
# - Deploy Terraform infrastructure
# - Upload Glue scripts to S3
# - No manual approval required

env:
  AWS_REGION: eu-central-1
  ENVIRONMENT: dev

jobs:
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies and build
        run: |
          poetry install --no-interaction --no-ansi || echo "No dependencies"
          echo "Build step skipped - Glue uses raw Python files"
      
      - name: Terraform Init
        working-directory: terraform/environments/dev
        run: terraform init
      
      - name: Terraform Plan
        working-directory: terraform/environments/dev
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: terraform/environments/dev
        run: terraform apply -auto-approve tfplan
      
      - name: Get Terraform Outputs
        id: tf_outputs
        working-directory: terraform/environments/dev
        run: |
          echo "data_bucket=$(terraform output -raw data_bucket_name)" >> $GITHUB_OUTPUT
          echo "check_job=$(terraform output -raw glue_check_job_name)" >> $GITHUB_OUTPUT
          echo "extract_job=$(terraform output -raw glue_extract_job_name)" >> $GITHUB_OUTPUT
      
      - name: Upload Glue Scripts
        run: |
          # Scripts are already uploaded by Terraform, but we can update them here
          echo "Glue scripts deployed via Terraform"
      
      - name: Trigger Pipeline Execution
        id: trigger_pipeline
        run: |
          # Get state machine ARN from Terraform output
          STATE_MACHINE_ARN=$(cd terraform/environments/dev && terraform output -raw state_machine_arn)
          
          # Generate unique execution name
          EXECUTION_NAME="auto-deploy-$(date +%s)"
          
          # Start execution
          EXECUTION_ARN=$(aws stepfunctions start-execution \
            --state-machine-arn "$STATE_MACHINE_ARN" \
            --name "$EXECUTION_NAME" \
            --query 'executionArn' \
            --output text)
          
          echo "execution_arn=$EXECUTION_ARN" >> $GITHUB_OUTPUT
          echo "execution_name=$EXECUTION_NAME" >> $GITHUB_OUTPUT
          
          echo "Pipeline triggered: $EXECUTION_NAME"
          echo "Execution ARN: $EXECUTION_ARN"
      
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary - Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data Bucket:** ${{ steps.tf_outputs.outputs.data_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Job:** ${{ steps.tf_outputs.outputs.check_job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Extract Job:** ${{ steps.tf_outputs.outputs.extract_job }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pipeline Execution" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Name:** ${{ steps.trigger_pipeline.outputs.execution_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ARN:** ${{ steps.trigger_pipeline.outputs.execution_arn }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed and pipeline triggered!" >> $GITHUB_STEP_SUMMARY
