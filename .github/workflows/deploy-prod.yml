name: CD - Deploy to Production

on:
  workflow_dispatch:  # Manual trigger for production (requires approval)
    inputs:
      confirm_deploy:
        description: 'Type "deploy-to-prod" to confirm'
        required: true
        default: ''

# PRODUCTION DEPLOYMENT STRATEGY:
# - Manual trigger only (no auto-deploy)
# - Can deploy from main branch after testing in dev
# - Use production AWS credentials
# - Create deployment tag
# - Type "deploy-to-prod" to confirm deployment
# - Send notification on completion

permissions:
  contents: write  # Allow creating tags and pushing to repo
  id-token: write  # For AWS OIDC (future improvement)

env:
  AWS_REGION: eu-central-1
  ENVIRONMENT: prod

jobs:
  validate-input:
    name: Validate Deployment Input
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deploy }}" != "deploy-to-prod" ]; then
            echo " Confirmation text does not match. Aborting deployment."
            exit 1
          fi
          echo " Deployment confirmed"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production  # Requires manual approval in GitHub settings
    needs: [validate-input]
    if: always() && (needs.validate-input.result == 'success' || github.event_name == 'push')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies and build
        run: |
          poetry install --no-interaction --no-ansi || echo "No dependencies"
          echo "Build step skipped - Glue uses raw Python files"
      
      - name: Terraform Init
        working-directory: terraform/environments/prod
        run: terraform init
      
      - name: Terraform Plan
        working-directory: terraform/environments/prod
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: terraform/environments/prod
        run: terraform apply -auto-approve tfplan
      
      - name: Get Terraform Outputs
        id: tf_outputs
        working-directory: terraform/environments/prod
        run: |
          echo "data_bucket=$(terraform output -raw data_bucket_name)" >> $GITHUB_OUTPUT
          echo "check_job=$(terraform output -raw glue_check_job_name)" >> $GITHUB_OUTPUT
          echo "extract_job=$(terraform output -raw glue_extract_job_name)" >> $GITHUB_OUTPUT
          echo "state_machine=$(terraform output -raw state_machine_arn)" >> $GITHUB_OUTPUT
      
      - name: Trigger Pipeline Execution
        id: trigger_pipeline
        run: |
          # Get state machine ARN from Terraform output
          STATE_MACHINE_ARN=$(cd terraform/environments/prod && terraform output -raw state_machine_arn)
          
          # Generate unique execution name
          EXECUTION_NAME="prod-deploy-$(date +%s)"
          
          # Start execution
          EXECUTION_ARN=$(aws stepfunctions start-execution \
            --state-machine-arn "$STATE_MACHINE_ARN" \
            --name "$EXECUTION_NAME" \
            --query 'executionArn' \
            --output text)
          
          echo "execution_arn=$EXECUTION_ARN" >> $GITHUB_OUTPUT
          echo "execution_name=$EXECUTION_NAME" >> $GITHUB_OUTPUT
          
          echo "Production pipeline triggered: $EXECUTION_NAME"
          echo "Execution ARN: $EXECUTION_ARN"
      
      - name: Create Deployment Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          TAG="prod-$(date +%Y%m%d-%H%M%S)"
          git tag -a $TAG -m "Production deployment $TAG"
          git push origin $TAG
      
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary - Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data Bucket:** ${{ steps.tf_outputs.outputs.data_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Job:** ${{ steps.tf_outputs.outputs.check_job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Extract Job:** ${{ steps.tf_outputs.outputs.extract_job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **State Machine:** ${{ steps.tf_outputs.outputs.state_machine }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pipeline Execution" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Name:** ${{ steps.trigger_pipeline.outputs.execution_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ARN:** ${{ steps.trigger_pipeline.outputs.execution_arn }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Production deployment completed and pipeline triggered!" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-prod]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy-prod.result }}" == "success" ]; then
            echo " Production deployment successful"
          else
            echo " Production deployment failed"
            exit 1
          fi
